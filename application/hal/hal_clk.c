/*	header info, to be added
 *
 *
 *
 */


/*******************************************************************************
 *                              INCLUDE FILES
 ******************************************************************************/
#include "hal_clk.h"

/*******************************************************************************
 *                              DEFINES
 ******************************************************************************/
#define HAL_CLK_HFCLKSTAT_STATE_MASK        (1UL << 16)
#define HAL_CLK_HFCLKSTAT_SOURCE_MASK       (1UL)

/*******************************************************************************
 *                          PRIVATE FUNCTION DECLARATIONS
 ******************************************************************************/
static bool HAL_CLK_hfclkCheckState(void);
static bool HAL_CLK_hfclkCheckSrc(void);

/*******************************************************************************
 *                          PUBLIC FUNCTION DEFINITIONS
 ******************************************************************************/
/*******************************************************************************
 * @brief Starts HFCLK clock.
 ******************************************************************************
 * @param None.
 ******************************************************************************
 * @author  mario.kodba
 * @date    20.12.2020.
 ******************************************************************************/
void HAL_CLK_hfclkStart(void) {

    // start 16 MHz crystal oscillator
    // clear interrupt pending
    NRF_CLOCK->EVENTS_HFCLKSTARTED = 0u;
    // 32MHz crystal as source
    NRF_CLOCK->XTALFREQ = 0x00u;
    NRF_CLOCK->TASKS_HFCLKSTART = 1u;

    // wait for the external oscillator to start up - it will set the flag to 1
    while (NRF_CLOCK->EVENTS_HFCLKSTARTED == 0);

    HAL_CLK_hfclkCheckSrc();
}

/*******************************************************************************
 * @brief Stops HFCLK clock.
 ******************************************************************************
 * @param None.
 ******************************************************************************
 * @author  mario.kodba
 * @date    26.12.2020.
 ******************************************************************************/
void HAL_CLK_hfclkStop(void) {

    bool state = HAL_CLK_hfclkCheckState();

    // stop HFCLK if it's running
    if(state == true) {
        NRF_CLOCK->TASKS_HFCLKSTOP = 1UL;
    }
}

/*******************************************************************************
 *                         PRIVATE FUNCTION DEFINITIONS
 ******************************************************************************/
/*******************************************************************************
 * @brief Checks HFCLK state.
 ******************************************************************************
 * @param None.
 ******************************************************************************
 * @author  mario.kodba
 * @date    26.12.2020.
 ******************************************************************************/
static bool HAL_CLK_hfclkCheckState(void) {

    bool state = (NRF_CLOCK->HFCLKSTAT & HAL_CLK_HFCLKSTAT_STATE_MASK);

    return state;
}

/*******************************************************************************
 * @brief Checks HFCLK source.
 ******************************************************************************
 * @param None.
 ******************************************************************************
 * @author  mario.kodba
 * @date    26.12.2020.
 ******************************************************************************/
static bool HAL_CLK_hfclkCheckSrc(void) {

    uint32_t tmp = NRF_CLOCK->HFCLKSTAT;
    bool source = (NRF_CLOCK->HFCLKSTAT & HAL_CLK_HFCLKSTAT_SOURCE_MASK);

    return source;
}
/*******************************************************************************
 *                          END OF FILE
 ******************************************************************************/
